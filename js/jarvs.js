/**
 * ================================================================
 * JARVS - SISTEMA COMPLETO COM TODAS AS FUNCIONALIDADES
 * ================================================================
 */

console.log('ü§ñ Carregando Jarvs Completo...');

// ================================================================
// M√ìDULO 1: GERENCIAMENTO DE DADOS E USU√ÅRIO
// ================================================================

function getUsuarioAtual() {
    const usuarioAtualDoc = sessionStorage.getItem('usuarioAtual');
    if (!usuarioAtualDoc) return null;
    
    try {
        const usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
        return usuarios.find(u => u.documento && u.documento.replace(/[^\d]+/g, '') === usuarioAtualDoc);
    } catch (e) {
        console.error("Erro ao ler usu√°rios do localStorage:", e);
        return null;
    }
}

// ================================================================
// M√ìDULO 2: CLASSE DE AN√ÅLISE FINANCEIRA COMPLETA
// ================================================================

class AnaliseFinanceiraAvancada {
    constructor() {
        this.nomeUsuario = "Usu√°rio";
        this.apiKey = "AIzaSyCKiPzehfpybeI76whY0i1EwhowGrCQwqA";
        this.apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${this.apiKey}`;
        this.carregarNomeUsuario();
        
        this.cacheAnalises = new Map();
        this.ultimaAtualizacao = null;
    }

    carregarNomeUsuario() {
        if (typeof getUsuarioAtual === 'function') {
            const usuario = getUsuarioAtual();
            if (usuario && usuario.nome) {
                this.nomeUsuario = usuario.nome.split(' ')[0];
            }
        }
    }

    formatarMoeda(valor) {
        if (typeof valor !== 'number') valor = 0;
        return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    formatarData(dataString) {
        if (!dataString) return 'Data n√£o informada';
        const data = new Date(dataString);
        return data.toLocaleDateString('pt-BR');
    }

    formatarPorcentagem(valor) {
        return `${valor.toFixed(1)}%`;
    }

    obterNomeMes(index) {
        const nomes = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                      'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        return nomes[index] || 'M√™s inv√°lido';
    }

    obterDadosAno(ano = null) {
        if (!ano) ano = typeof anoAtual !== 'undefined' ? anoAtual : new Date().getFullYear();
        return dadosFinanceiros[ano] || null;
    }

    getValorRealDespesa(despesa) {
        if (!despesa) return 0;
        
        if (despesa.valorPago !== null && despesa.valorPago !== undefined && despesa.valorPago > 0) {
            return parseFloat(despesa.valorPago);
        }
        
        return parseFloat(despesa.valor) || 0;
    }

    calcularTotalReceitas(receitas) {
        if (!receitas || !Array.isArray(receitas)) return 0;
        return receitas.reduce((acc, r) => acc + (parseFloat(r.valor) || 0), 0);
    }

    calcularTotalDespesas(despesas) {
        if (!despesas || !Array.isArray(despesas)) return 0;
        return despesas.reduce((acc, d) => acc + this.getValorRealDespesa(d), 0);
    }

    // AN√ÅLISE COMPLETA DO PER√çODO
    analisarPeriodoCompleto(anoParam = null) {
        const ano = anoParam || (typeof anoAtual !== 'undefined' ? anoAtual : new Date().getFullYear());
        const dados = this.obterDadosAno(ano);
        
        if (!dados) return null;

        let analise = {
            ano: ano,
            totalReceitas: 0,
            totalDespesas: 0,
            saldoFinal: 0,
            meses: [],
            categorias: new Map(),
            formasPagamento: new Map(),
            parcelamentos: [],
            despesasAtrasadas: [],
            despesasPagas: [],
            despesasPendentes: [],
            jurosTotal: 0,
            estatisticas: {}
        };

        const hoje = new Date();

        for (let mes = 0; mes < 12; mes++) {
            const dadosMes = dados.meses[mes];
            if (!dadosMes) continue;

            const receitasMes = this.calcularTotalReceitas(dadosMes.receitas || []);
            const despesasMes = this.calcularTotalDespesas(dadosMes.despesas || []);
            const saldoMes = receitasMes - despesasMes;

            analise.totalReceitas += receitasMes;
            analise.totalDespesas += despesasMes;

            analise.meses[mes] = {
                receitas: receitasMes,
                despesas: despesasMes,
                saldo: saldoMes,
                qtdReceitas: (dadosMes.receitas || []).length,
                qtdDespesas: (dadosMes.despesas || []).length
            };

            (dadosMes.despesas || []).forEach(despesa => {
                const categoria = despesa.categoria || 'Sem categoria';
                const forma = despesa.formaPagamento || 'N√£o informado';
                const valor = this.getValorRealDespesa(despesa);

                analise.categorias.set(categoria, (analise.categorias.get(categoria) || 0) + valor);
                analise.formasPagamento.set(forma, (analise.formasPagamento.get(forma) || 0) + valor);

                if (despesa.parcelado) {
                    analise.parcelamentos.push({
                        ...despesa,
                        mes: mes,
                        nomeMes: this.obterNomeMes(mes)
                    });
                }

                if (despesa.quitado) {
                    analise.despesasPagas.push({
                        ...despesa,
                        mes: mes,
                        nomeMes: this.obterNomeMes(mes)
                    });
                } else {
                    const dataVencimento = new Date(despesa.dataVencimento || despesa.data);
                    if (dataVencimento < hoje) {
                        const diasAtraso = Math.floor((hoje - dataVencimento) / (1000 * 60 * 60 * 24));
                        analise.despesasAtrasadas.push({
                            ...despesa,
                            mes: mes,
                            nomeMes: this.obterNomeMes(mes),
                            diasAtraso: diasAtraso
                        });
                    } else {
                        analise.despesasPendentes.push({
                            ...despesa,
                            mes: mes,
                            nomeMes: this.obterNomeMes(mes)
                        });
                    }
                }

                if (despesa.metadados && despesa.metadados.totalJuros) {
                    analise.jurosTotal += despesa.metadados.jurosPorParcela || despesa.metadados.totalJuros;
                } else if (despesa.valorPago && despesa.valorPago > despesa.valor) {
                    analise.jurosTotal += (despesa.valorPago - despesa.valor);
                }
            });
        }

        analise.saldoFinal = analise.totalReceitas - analise.totalDespesas;
        this.calcularEstatisticas(analise);
        return analise;
    }

    calcularEstatisticas(analise) {
        let maiorReceita = { valor: -1, mes: -1 };
        let menorReceita = { valor: Number.POSITIVE_INFINITY, mes: -1 };
        let maiorDespesa = { valor: -1, mes: -1 };
        let menorDespesa = { valor: Number.POSITIVE_INFINITY, mes: -1 };
        let melhorSaldo = { valor: Number.NEGATIVE_INFINITY, mes: -1 };
        let piorSaldo = { valor: Number.POSITIVE_INFINITY, mes: -1 };

        analise.meses.forEach((dadosMes, mes) => {
            if (!dadosMes) return;

            if (dadosMes.receitas > maiorReceita.valor) {
                maiorReceita = { valor: dadosMes.receitas, mes };
            }
            if (dadosMes.receitas < menorReceita.valor && dadosMes.receitas > 0) {
                menorReceita = { valor: dadosMes.receitas, mes };
            }

            if (dadosMes.despesas > maiorDespesa.valor) {
                maiorDespesa = { valor: dadosMes.despesas, mes };
            }
            if (dadosMes.despesas < menorDespesa.valor && dadosMes.despesas > 0) {
                menorDespesa = { valor: dadosMes.despesas, mes };
            }

            if (dadosMes.saldo > melhorSaldo.valor) {
                melhorSaldo = { valor: dadosMes.saldo, mes };
            }
            if (dadosMes.saldo < piorSaldo.valor) {
                piorSaldo = { valor: dadosMes.saldo, mes };
            }
        });

        analise.estatisticas = {
            maiorReceita,
            menorReceita,
            maiorDespesa,
            menorDespesa,
            melhorSaldo,
            piorSaldo,
            mediaReceitasMensal: analise.totalReceitas / 12,
            mediaDespesasMensal: analise.totalDespesas / 12,
            taxaPoupanca: analise.totalReceitas > 0 ? ((analise.saldoFinal / analise.totalReceitas) * 100) : 0
        };
    }

    // PROCESSAMENTO INTELIGENTE DE PERGUNTAS
    async processarPergunta(pergunta) {
        const p = pergunta.toLowerCase().trim();
        this.carregarNomeUsuario();
        
        const ano = typeof anoAtual !== 'undefined' ? anoAtual : new Date().getFullYear();
        const analise = this.analisarPeriodoCompleto(ano);
        
        if (!analise) {
            return `<p>Desculpe, ${this.nomeUsuario}, mas n√£o encontrei dados financeiros para o ano de ${ano}. Por favor, adicione algumas receitas ou despesas para come√ßar.</p>`;
        }

        // An√°lise de meses espec√≠ficos
        const meses = {
            'janeiro': 0, 'fevereiro': 1, 'mar√ßo': 2, 'abril': 3, 'maio': 4, 'junho': 5,
            'julho': 6, 'agosto': 7, 'setembro': 8, 'outubro': 9, 'novembro': 10, 'dezembro': 11
        };
        
        let mesEspecifico = -1;
        for (const [nome, index] of Object.entries(meses)) {
            if (p.includes(nome)) {
                mesEspecifico = index;
                break;
            }
        }

        if (mesEspecifico !== -1) {
            return this.analisarMesEspecifico(mesEspecifico, analise);
        }

        // Compara√ß√µes entre meses
        if (p.includes('comparar')) {
            const mesesNaPergunta = Object.keys(meses).filter(m => p.includes(m));
            if (mesesNaPergunta.length === 2) {
                return this.compararMeses(meses[mesesNaPergunta[0]], meses[mesesNaPergunta[1]], analise);
            }
        }

        // Perguntas sobre categorias
        if (p.includes('categoria')) {
            if (p.includes('maior') || p.includes('mais gastei')) {
                return this.analisarCategorias(analise, 'maior');
            }
            if (p.includes('menor') || p.includes('menos gastei')) {
                return this.analisarCategorias(analise, 'menor');
            }
            if (p.includes('todas') || p.includes('listar')) {
                return this.listarTodasCategorias(analise);
            }
            return this.analisarCategorias(analise, 'completa');
        }

        // Perguntas sobre formas de pagamento
        if (p.includes('forma de pagamento') || p.includes('pix') || p.includes('d√©bito') || p.includes('cr√©dito')) {
            return this.analisarFormasPagamento(analise);
        }

        // Perguntas sobre parcelamentos
        if (p.includes('parcela') || p.includes('parcelamento')) {
            return this.analisarParcelamentos(analise);
        }

        // Perguntas sobre despesas atrasadas/pagas/pendentes
        if (p.includes('atrasad')) {
            return this.analisarDespesasAtrasadas(analise);
        }
        if (p.includes('paga') || p.includes('quitad')) {
            return this.analisarDespesasPagas(analise);
        }
        if (p.includes('pendente')) {
            return this.analisarDespesasPendentes(analise);
        }

        // Perguntas sobre juros
        if (p.includes('juros')) {
            return this.analisarJuros(analise);
        }

        // Perguntas sobre sa√∫de financeira
        if (p.includes('sa√∫de financeira') || p.includes('como est√°') || p.includes('situa√ß√£o financeira')) {
            return this.verificarSaudeFinanceira(analise);
        }

        // Perguntas sobre resumos
        if (p.includes('resumo') || p.includes('total do ano') || p.includes('balan√ßo')) {
            return this.gerarResumoCompleto(analise);
        }

        // Perguntas sobre estat√≠sticas
        if (p.includes('maior receita') || p.includes('m√™s que mais ganhei')) {
            return this.responderEstatistica(analise, 'maiorReceita');
        }
        if (p.includes('menor receita') || p.includes('m√™s que menos ganhei')) {
            return this.responderEstatistica(analise, 'menorReceita');
        }
        if (p.includes('maior despesa') || p.includes('m√™s que mais gastei')) {
            return this.responderEstatistica(analise, 'maiorDespesa');
        }
        if (p.includes('menor despesa') || p.includes('m√™s que menos gastei')) {
            return this.responderEstatistica(analise, 'menorDespesa');
        }
        if (p.includes('melhor saldo') || p.includes('melhor m√™s')) {
            return this.responderEstatistica(analise, 'melhorSaldo');
        }
        if (p.includes('pior saldo') || p.includes('pior m√™s')) {
            return this.responderEstatistica(analise, 'piorSaldo');
        }

        // Perguntas sobre m√©dias
        if (p.includes('m√©dia') || p.includes('em m√©dia')) {
            return this.analisarMedias(analise);
        }

        // Se n√£o encontrou padr√£o espec√≠fico, usar IA do Gemini
        return await this.callJarvsAPI(pergunta, analise);
    }

    // ANALISAR M√äS ESPEC√çFICO
    analisarMesEspecifico(mes, analise) {
        const nomeMes = this.obterNomeMes(mes);
        const dadosMes = analise.meses[mes];
        
        if (!dadosMes || (dadosMes.qtdReceitas === 0 && dadosMes.qtdDespesas === 0)) {
            return `<p>üìÖ ${this.nomeUsuario}, n√£o h√° dados para ${nomeMes} de ${analise.ano}.</p>`;
        }

        const dados = this.obterDadosAno(analise.ano);
        const mesData = dados.meses[mes];
        
        let detalhesReceitas = '';
        if (mesData.receitas && mesData.receitas.length > 0) {
            detalhesReceitas = `
                <p><strong>üí∞ Receitas (${mesData.receitas.length}):</strong></p>
                <ul>
                    ${mesData.receitas.slice(0, 5).map(r => 
                        `<li>${r.descricao}: ${this.formatarMoeda(r.valor)} - ${this.formatarData(r.data)}</li>`
                    ).join('')}
                    ${mesData.receitas.length > 5 ? `<li><em>...e mais ${mesData.receitas.length - 5} receitas</em></li>` : ''}
                </ul>
            `;
        }

        let detalhesDespesas = '';
        if (mesData.despesas && mesData.despesas.length > 0) {
            detalhesDespesas = `
                <p><strong>üí∏ Despesas (${mesData.despesas.length}):</strong></p>
                <ul>
                    ${mesData.despesas.slice(0, 5).map(d => 
                        `<li>${d.descricao}: ${this.formatarMoeda(this.getValorRealDespesa(d))} - ${d.categoria || 'Sem categoria'}</li>`
                    ).join('')}
                    ${mesData.despesas.length > 5 ? `<li><em>...e mais ${mesData.despesas.length - 5} despesas</em></li>` : ''}
                </ul>
            `;
        }

        return `
            <p><strong>üìä An√°lise de ${nomeMes} ${analise.ano}:</strong></p>
            <ul>
                <li>üí∞ <strong>Total de Receitas:</strong> ${this.formatarMoeda(dadosMes.receitas)}</li>
                <li>üí∏ <strong>Total de Despesas:</strong> ${this.formatarMoeda(dadosMes.despesas)}</li>
                <li>${dadosMes.saldo >= 0 ? '‚úÖ' : '‚ùå'} <strong>Saldo:</strong> ${this.formatarMoeda(dadosMes.saldo)}</li>
            </ul>
            ${detalhesReceitas}
            ${detalhesDespesas}
        `;
    }

    // COMPARAR MESES
    compararMeses(mes1, mes2, analise) {
        const nome1 = this.obterNomeMes(mes1);
        const nome2 = this.obterNomeMes(mes2);
        const dados1 = analise.meses[mes1];
        const dados2 = analise.meses[mes2];

        if (!dados1 || !dados2) {
            return `<p>N√£o tenho dados suficientes para comparar ${nome1} e ${nome2}.</p>`;
        }

        const calcularVariacao = (val1, val2) => {
            if (val2 === 0) return val1 > 0 ? '+‚àû%' : '0%';
            const variacao = ((val1 - val2) / val2) * 100;
            const sinal = variacao >= 0 ? '+' : '';
            return `${sinal}${variacao.toFixed(1)}%`;
        };

        return `
            <p><strong>üîÑ Comparativo: ${nome1} vs ${nome2}</strong></p>
            
            <p><strong>${nome1}:</strong></p>
            <ul>
                <li>Receitas: ${this.formatarMoeda(dados1.receitas)}</li>
                <li>Despesas: ${this.formatarMoeda(dados1.despesas)}</li>
                <li>Saldo: ${this.formatarMoeda(dados1.saldo)}</li>
            </ul>
            
            <p><strong>${nome2}:</strong></p>
            <ul>
                <li>Receitas: ${this.formatarMoeda(dados2.receitas)} (${calcularVariacao(dados2.receitas, dados1.receitas)})</li>
                <li>Despesas: ${this.formatarMoeda(dados2.despesas)} (${calcularVariacao(dados2.despesas, dados1.despesas)})</li>
                <li>Saldo: ${this.formatarMoeda(dados2.saldo)} (${calcularVariacao(dados2.saldo, dados1.saldo)})</li>
            </ul>
        `;
    }

    // ANALISAR CATEGORIAS
    analisarCategorias(analise, tipo = 'completa') {
        if (analise.categorias.size === 0) {
            return `<p>${this.nomeUsuario}, voc√™ ainda n√£o possui categorias de despesas cadastradas.</p>`;
        }

        const categoriasArray = Array.from(analise.categorias.entries())
            .sort(([,a], [,b]) => b - a);

        if (tipo === 'maior') {
            const [categoria, valor] = categoriasArray[0];
            const percentual = (valor / analise.totalDespesas) * 100;
            
            return `
                <p><strong>üèÜ Categoria com maior gasto em ${analise.ano}:</strong></p>
                <ul>
                    <li><strong>${categoria}:</strong> ${this.formatarMoeda(valor)}</li>
                    <li><strong>Percentual do total:</strong> ${this.formatarPorcentagem(percentual)}</li>
                </ul>
                <p><strong>üí° Dica do Jarvs:</strong> Esta √© sua principal √°rea de gastos. Vale a pena revisar se h√° oportunidades de economia!</p>
            `;
        }

        if (tipo === 'menor') {
            const [categoria, valor] = categoriasArray[categoriasArray.length - 1];
            const percentual = (valor / analise.totalDespesas) * 100;
            
            return `
                <p><strong>üìâ Categoria com menor gasto em ${analise.ano}:</strong></p>
                <ul>
                    <li><strong>${categoria}:</strong> ${this.formatarMoeda(valor)}</li>
                    <li><strong>Percentual do total:</strong> ${this.formatarPorcentagem(percentual)}</li>
                </ul>
            `;
        }

        return `
            <p><strong>üè∑Ô∏è An√°lise completa por categorias (${categoriasArray.length}):</strong></p>
            <ul>
                ${categoriasArray.slice(0, 8).map(([cat, valor], i) => {
                    const percentual = (valor / analise.totalDespesas) * 100;
                    return `<li>${i + 1}. <strong>${cat}:</strong> ${this.formatarMoeda(valor)} (${this.formatarPorcentagem(percentual)})</li>`;
                }).join('')}
                ${categoriasArray.length > 8 ? `<li><em>...e mais ${categoriasArray.length - 8} categorias</em></li>` : ''}
            </ul>
        `;
    }

    // ANALISAR FORMAS DE PAGAMENTO
    analisarFormasPagamento(analise) {
        if (analise.formasPagamento.size === 0) {
            return `<p>${this.nomeUsuario}, n√£o encontrei formas de pagamento cadastradas.</p>`;
        }

        const formasArray = Array.from(analise.formasPagamento.entries())
            .sort(([,a], [,b]) => b - a);

        const formasNomes = {
            'pix': 'üì± PIX',
            'debito': 'üí≥ D√©bito',
            'credito': 'üè¶ Cr√©dito',
            'dinheiro': 'üíµ Dinheiro'
        };

        return `
            <p><strong>üí≥ An√°lise por forma de pagamento em ${analise.ano}:</strong></p>
            <ul>
                ${formasArray.map(([forma, valor]) => {
                    const percentual = (valor / analise.totalDespesas) * 100;
                    const icone = formasNomes[forma] || `‚ùì ${forma}`;
                    return `<li><strong>${icone}:</strong> ${this.formatarMoeda(valor)} (${this.formatarPorcentagem(percentual)})</li>`;
                }).join('')}
            </ul>
            <p><strong>Total:</strong> ${this.formatarMoeda(analise.totalDespesas)}</p>
        `;
    }

    // ANALISAR PARCELAMENTOS
    analisarParcelamentos(analise) {
        if (analise.parcelamentos.length === 0) {
            return `<p>üéâ ${this.nomeUsuario}, voc√™ n√£o possui parcelamentos ativos em ${analise.ano}!</p>`;
        }

        const totalParcelado = analise.parcelamentos.reduce((acc, p) => acc + this.getValorRealDespesa(p), 0);
        const comprasUnicas = new Set(analise.parcelamentos.map(p => p.descricao));

        return `
            <p><strong>üí≥ An√°lise de parcelamentos em ${analise.ano}:</strong></p>
            <ul>
                <li><strong>Total de parcelas:</strong> ${analise.parcelamentos.length}</li>
                <li><strong>Compras parceladas:</strong> ${comprasUnicas.size}</li>
                <li><strong>Valor total:</strong> ${this.formatarMoeda(totalParcelado)}</li>
            </ul>
            
            <p><strong>Principais parcelamentos:</strong></p>
            <ul>
                ${analise.parcelamentos.slice(0, 5).map(p => 
                    `<li><strong>${p.descricao}:</strong> ${this.formatarMoeda(this.getValorRealDespesa(p))} - ${p.parcela} (${p.nomeMes})</li>`
                ).join('')}
                ${analise.parcelamentos.length > 5 ? `<li><em>...e mais ${analise.parcelamentos.length - 5} parcelas</em></li>` : ''}
            </ul>
        `;
    }

    // ANALISAR DESPESAS ATRASADAS
    analisarDespesasAtrasadas(analise) {
        if (analise.despesasAtrasadas.length === 0) {
            return `<p>‚úÖ ${this.nomeUsuario}, parab√©ns! Voc√™ n√£o possui despesas atrasadas.</p>`;
        }

        const totalAtrasado = analise.despesasAtrasadas.reduce((acc, d) => acc + this.getValorRealDespesa(d), 0);
        analise.despesasAtrasadas.sort((a, b) => b.diasAtraso - a.diasAtraso);

        return `
            <p><strong>‚ö†Ô∏è Despesas atrasadas (${analise.despesasAtrasadas.length}):</strong></p>
            <p><strong>Total em atraso:</strong> ${this.formatarMoeda(totalAtrasado)}</p>
            <ul>
                ${analise.despesasAtrasadas.slice(0, 5).map(d => 
                    `<li><strong>${d.descricao}:</strong> ${this.formatarMoeda(this.getValorRealDespesa(d))} - ${d.diasAtraso} dias (${d.nomeMes})</li>`
                ).join('')}
                ${analise.despesasAtrasadas.length > 5 ? `<li><em>...e mais ${analise.despesasAtrasadas.length - 5} despesas</em></li>` : ''}
            </ul>
            <p><strong>üö® A√ß√£o recomendada:</strong> Priorize o pagamento das despesas mais antigas para evitar juros!</p>
        `;
    }

    // ANALISAR DESPESAS PAGAS
    analisarDespesasPagas(analise) {
        if (analise.despesasPagas.length === 0) {
            return `<p>${this.nomeUsuario}, voc√™ ainda n√£o possui despesas pagas registradas este ano.</p>`;
        }

        const totalPago = analise.despesasPagas.reduce((acc, d) => acc + this.getValorRealDespesa(d), 0);

        return `
            <p><strong>‚úÖ Despesas pagas (${analise.despesasPagas.length}):</strong></p>
            <p><strong>Total pago:</strong> ${this.formatarMoeda(totalPago)}</p>
            <ul>
                ${analise.despesasPagas.slice(0, 5).map(d => 
                    `<li><strong>${d.descricao}:</strong> ${this.formatarMoeda(this.getValorRealDespesa(d))} - ${d.nomeMes}</li>`
                ).join('')}
                ${analise.despesasPagas.length > 5 ? `<li><em>...e mais ${analise.despesasPagas.length - 5} despesas</em></li>` : ''}
            </ul>
        `;
    }

    // ANALISAR DESPESAS PENDENTES
    analisarDespesasPendentes(analise) {
        if (analise.despesasPendentes.length === 0) {
            return `<p>üéâ ${this.nomeUsuario}, voc√™ n√£o possui despesas pendentes!</p>`;
        }

        const totalPendente = analise.despesasPendentes.reduce((acc, d) => acc + this.getValorRealDespesa(d), 0);

        return `
            <p><strong>‚è≥ Despesas pendentes (${analise.despesasPendentes.length}):</strong></p>
            <p><strong>Total pendente:</strong> ${this.formatarMoeda(totalPendente)}</p>
            <ul>
                ${analise.despesasPendentes.slice(0, 5).map(d => 
                    `<li><strong>${d.descricao}:</strong> ${this.formatarMoeda(this.getValorRealDespesa(d))} - ${d.nomeMes}</li>`
                ).join('')}
                ${analise.despesasPendentes.length > 5 ? `<li><em>...e mais ${analise.despesasPendentes.length - 5} despesas</em></li>` : ''}
            </ul>
        `;
    }

    // ANALISAR JUROS
    analisarJuros(analise) {
        if (analise.jurosTotal === 0) {
            return `<p>üëç ${this.nomeUsuario}, excelente! Voc√™ n√£o pagou juros este ano.</p>`;
        }

        const percentualJuros = (analise.jurosTotal / analise.totalDespesas) * 100;

        return `
            <p><strong>üí∏ An√°lise de Juros em ${analise.ano}:</strong></p>
            <ul>
                <li><strong>Total gasto com juros:</strong> ${this.formatarMoeda(analise.jurosTotal)}</li>
                <li><strong>Percentual das despesas:</strong> ${this.formatarPorcentagem(percentualJuros)}</li>
            </ul>
            <p><strong>üí° Dica do Jarvs:</strong> ${percentualJuros > 5 ? 
                'Seus juros est√£o altos! Considere quitar d√≠vidas e evitar o rotativo do cart√£o.' : 
                'Voc√™ mant√©m seus juros sob controle. Parab√©ns!'}</p>
        `;
    }

    // VERIFICAR SA√öDE FINANCEIRA
    verificarSaudeFinanceira(analise) {
        const taxaPoupanca = analise.estatisticas.taxaPoupanca;
        let nivel, emoji, conselho;

        if (taxaPoupanca >= 20) {
            nivel = "Excelente";
            emoji = "üèÜ";
            conselho = "Voc√™ est√° no caminho certo! Considere diversificar seus investimentos.";
        } else if (taxaPoupanca >= 10) {
            nivel = "Boa";
            emoji = "üëç";
            conselho = "Situa√ß√£o positiva! Tente aumentar gradualmente sua taxa de poupan√ßa.";
        } else if (taxaPoupanca > 0) {
            nivel = "Aten√ß√£o";
            emoji = "‚ö†Ô∏è";
            conselho = "Cuidado! Revise seus gastos e crie metas de economia.";
        } else {
            nivel = "Cr√≠tica";
            emoji = "üö®";
            conselho = "Alerta! Voc√™ est√° gastando mais do que ganha. A√ß√£o urgente necess√°ria!";
        }

        return `
            <p><strong>${emoji} Sa√∫de Financeira de ${analise.ano}:</strong></p>
            <ul>
                <li><strong>Diagn√≥stico:</strong> ${nivel}</li>
                <li><strong>Taxa de Poupan√ßa:</strong> ${this.formatarPorcentagem(taxaPoupanca)}</li>
                <li><strong>Receitas Totais:</strong> ${this.formatarMoeda(analise.totalReceitas)}</li>
                <li><strong>Despesas Totais:</strong> ${this.formatarMoeda(analise.totalDespesas)}</li>
                <li><strong>Saldo Final:</strong> ${this.formatarMoeda(analise.saldoFinal)}</li>
            </ul>
            <p><strong>üí° Conselho do Jarvs:</strong> ${conselho}</p>
        `;
    }

    // GERAR RESUMO COMPLETO
    gerarResumoCompleto(analise) {
        const stats = analise.estatisticas;
        
        return `
            <p><strong>üìä Resumo Financeiro Completo de ${analise.ano}:</strong></p>
            
            <p><strong>üí∞ Vis√£o Geral:</strong></p>
            <ul>
                <li>Total de Receitas: ${this.formatarMoeda(analise.totalReceitas)}</li>
                <li>Total de Despesas: ${this.formatarMoeda(analise.totalDespesas)}</li>
                <li>Saldo Final: ${this.formatarMoeda(analise.saldoFinal)}</li>
                <li>Taxa de Poupan√ßa: ${this.formatarPorcentagem(stats.taxaPoupanca)}</li>
            </ul>
            
            <p><strong>üìà Estat√≠sticas dos Meses:</strong></p>
            <ul>
                <li>Melhor m√™s (saldo): ${this.obterNomeMes(stats.melhorSaldo.mes)} (${this.formatarMoeda(stats.melhorSaldo.valor)})</li>
                <li>Pior m√™s (saldo): ${this.obterNomeMes(stats.piorSaldo.mes)} (${this.formatarMoeda(stats.piorSaldo.valor)})</li>
                <li>Maior receita: ${this.obterNomeMes(stats.maiorReceita.mes)} (${this.formatarMoeda(stats.maiorReceita.valor)})</li>
                <li>Maior despesa: ${this.obterNomeMes(stats.maiorDespesa.mes)} (${this.formatarMoeda(stats.maiorDespesa.valor)})</li>
            </ul>
            
            <p><strong>üè∑Ô∏è Resumo por Status:</strong></p>
            <ul>
                <li>Despesas Pagas: ${analise.despesasPagas.length}</li>
                <li>Despesas Pendentes: ${analise.despesasPendentes.length}</li>
                <li>Despesas Atrasadas: ${analise.despesasAtrasadas.length}</li>
                <li>Parcelamentos Ativos: ${analise.parcelamentos.length}</li>
            </ul>
        `;
    }

    // RESPONDER ESTAT√çSTICA
    responderEstatistica(analise, tipo) {
        const stats = analise.estatisticas;
        const stat = stats[tipo];
        
        if (stat.mes === -1) {
            return `<p>${this.nomeUsuario}, n√£o encontrei dados suficientes para essa estat√≠stica.</p>`;
        }

        const nomeMes = this.obterNomeMes(stat.mes);
        const tipoTexto = {
            'maiorReceita': 'üí∞ M√™s com maior receita',
            'menorReceita': 'üìâ M√™s com menor receita', 
            'maiorDespesa': 'üí∏ M√™s com maior despesa',
            'menorDespesa': 'üìà M√™s com menor despesa',
            'melhorSaldo': 'üèÜ Melhor m√™s (saldo)',
            'piorSaldo': 'üìâ Pior m√™s (saldo)'
        };

        return `
            <p><strong>${tipoTexto[tipo]} em ${analise.ano}:</strong></p>
            <ul>
                <li><strong>M√™s:</strong> ${nomeMes}</li>
                <li><strong>Valor:</strong> ${this.formatarMoeda(stat.valor)}</li>
            </ul>
        `;
    }

    // ANALISAR M√âDIAS
    analisarMedias(analise) {
        const stats = analise.estatisticas;
        
        return `
            <p><strong>üìä An√°lise de M√©dias em ${analise.ano}:</strong></p>
            <ul>
                <li><strong>Receita m√©dia mensal:</strong> ${this.formatarMoeda(stats.mediaReceitasMensal)}</li>
                <li><strong>Despesa m√©dia mensal:</strong> ${this.formatarMoeda(stats.mediaDespesasMensal)}</li>
                <li><strong>Saldo m√©dio mensal:</strong> ${this.formatarMoeda(stats.mediaReceitasMensal - stats.mediaDespesasMensal)}</li>
            </ul>
            <p><strong>üí° Insight:</strong> Suas ${stats.mediaReceitasMensal > stats.mediaDespesasMensal ? 
                'receitas superam suas despesas em m√©dia. √ìtimo controle!' : 
                'despesas est√£o pr√≥ximas ou superiores √†s receitas. Aten√ß√£o ao or√ßamento!'}</p>
        `;
    }

    // LISTAR TODAS AS CATEGORIAS
    listarTodasCategorias(analise) {
        if (analise.categorias.size === 0) {
            return `<p>${this.nomeUsuario}, voc√™ ainda n√£o possui categorias cadastradas.</p>`;
        }

        const categorias = Array.from(analise.categorias.keys()).sort();
        
        return `
            <p><strong>üè∑Ô∏è Todas as suas categorias (${categorias.length}):</strong></p>
            <ul>
                ${categorias.map(cat => `<li>${cat}</li>`).join('')}
            </ul>
        `;
    }

    // ================================================================
    // INTEGRA√á√ÉO COM IA EXTERNA (GEMINI)
    // ================================================================

    async callJarvsAPI(prompt, analise = null) {
        if (!this.apiKey) {
            return `<p><strong>‚ö†Ô∏è Aten√ß√£o:</strong> A chave de API para o assistente Jarvs n√£o foi configurada.</p>`;
        }

        let contextoFinanceiro = '';
        if (analise) {
            contextoFinanceiro = `
            Contexto financeiro do usu√°rio (${analise.ano}):
            - Total de receitas: R$ ${analise.totalReceitas.toFixed(2)}
            - Total de despesas: R$ ${analise.totalDespesas.toFixed(2)}
            - Saldo: R$ ${analise.saldoFinal.toFixed(2)}
            - Taxa de poupan√ßa: ${analise.estatisticas.taxaPoupanca.toFixed(1)}%
            - Categorias principais: ${Array.from(analise.categorias.keys()).slice(0, 5).join(', ')}
            - Despesas atrasadas: ${analise.despesasAtrasadas.length}
            - Parcelamentos ativos: ${analise.parcelamentos.length}
            `;
        }

        const promptCompleto = `
        Voc√™ √© o Jarvs, um assistente financeiro virtual especializado. O usu√°rio se chama ${this.nomeUsuario}.
        
        ${contextoFinanceiro}
        
        Responda √† pergunta de forma clara, √∫til e personalizada. Use emojis apropriados e mantenha o tom amig√°vel.
        
        Pergunta: "${prompt}"
        `;

        try {
            const payload = {
                contents: [{
                    parts: [{ text: promptCompleto }]
                }]
            };

            const response = await fetch(this.apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                return `<p>Desculpe, ${this.nomeUsuario}, estou com problemas de conex√£o. Tente novamente em alguns minutos.</p>`;
            }

            const result = await response.json();
            const text = result.candidates[0]?.content?.parts[0]?.text || 
                        "N√£o consegui formular uma resposta adequada. Pode reformular a pergunta?";
            
            return `<p>${text}</p>`;
            
        } catch (error) {
            console.error("Erro ao chamar API do Jarvs:", error);
            return `<p>Ocorreu um problema t√©cnico. Verifique sua conex√£o e tente novamente.</p>`;
        }
    }
}

// ================================================================
// M√ìDULO 3: INTERFACE COMPLETA DO JARVS
// ================================================================

let jarvsInstance = null;

document.addEventListener('DOMContentLoaded', function() {
    console.log('ü§ñ Iniciando Jarvs Completo...');
    
    setTimeout(function() {
        const fabButton = document.getElementById('jarvs-fab');
        const modal = document.getElementById('ai-assistant-modal');
        
        console.log('FAB encontrado:', !!fabButton);
        console.log('Modal encontrado:', !!modal);
        
        if (!fabButton || !modal) {
            console.error('‚ùå Elementos do Jarvs n√£o encontrados');
            return;
        }

        // Criar inst√¢ncia √∫nica da IA
        if (!jarvsInstance) {
            jarvsInstance = new AnaliseFinanceiraAvancada();
            console.log('‚úÖ Inst√¢ncia Jarvs criada');
        }

        const closeModalBtn = modal.querySelector('.close');
        const sendBtn = document.getElementById('ai-send-btn');
        const inputField = document.getElementById('ai-input');
        const messagesContainer = document.getElementById('ai-messages');
        const typingIndicator = document.getElementById('ai-typing');

        // ================================================================
        // FUN√á√ïES DA INTERFACE
        // ================================================================

        const openModal = () => {
            console.log('üéØ Abrindo modal Jarvs...');
            modal.style.display = 'block';
            modal.style.visibility = 'visible';
            modal.style.opacity = '1';
            
            if (inputField) inputField.focus();
            jarvsInstance.carregarNomeUsuario();
            
            // Mensagem de boas-vindas se for a primeira vez
            if (messagesContainer && messagesContainer.children.length === 0) {
                addBotMessage(`
                    <p>Ol√°, ${jarvsInstance.nomeUsuario}! üëã</p>
                    <p>Sou o Jarvs, seu assistente financeiro inteligente. Posso ajudar com an√°lises sobre:</p>
                    <ul>
                        <li>üìä Receitas e despesas por per√≠odo</li>
                        <li>üè∑Ô∏è Categorias e formas de pagamento</li>
                        <li>üí≥ Parcelamentos e juros</li>
                        <li>üìà Sa√∫de financeira e compara√ß√µes</li>
                        <li>‚ö†Ô∏è Despesas atrasadas e pendentes</li>
                    </ul>
                    <p>O que gostaria de saber sobre suas finan√ßas?</p>
                `);
            }
        };

        const closeModal = () => {
            console.log('‚ùå Fechando modal Jarvs...');
            modal.style.display = 'none';
        };

        const scrollToBottom = () => {
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        };
        
        const showTyping = () => {
            if (typingIndicator) typingIndicator.style.display = 'flex';
            if (sendBtn) sendBtn.disabled = true;
            scrollToBottom();
        };
        
        const hideTyping = () => {
            if (typingIndicator) typingIndicator.style.display = 'none';
            if (sendBtn) sendBtn.disabled = false;
            if (inputField) inputField.focus();
        };

        const addUserMessage = (text) => {
            const messageEl = document.createElement('div');
            messageEl.className = 'ai-message ai-message-user';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'ai-content';
            contentDiv.innerHTML = `<p>${text}</p>`;

            messageEl.innerHTML = `
                <div class="ai-avatar">
                    <i class="fas fa-user"></i>
                </div>
            `;
            messageEl.appendChild(contentDiv);
            messagesContainer.appendChild(messageEl);
            scrollToBottom();
        };

        const addBotMessage = (html) => {
            const messageEl = document.createElement('div');
            messageEl.className = 'ai-message ai-message-bot';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'ai-content';
            contentDiv.innerHTML = html;

            messageEl.innerHTML = `
                <div class="ai-avatar">
                    <i class="fas fa-robot"></i>
                </div>
            `;
            messageEl.appendChild(contentDiv);
            messagesContainer.appendChild(messageEl);
            scrollToBottom();
        };

        const handleSendMessage = async () => {
            const userText = inputField.value.trim();
            if (!userText || sendBtn.disabled) return;

            console.log('üì§ Enviando pergunta:', userText);
            
            addUserMessage(userText);
            inputField.value = '';
            showTyping();

            try {
                const botResponseHtml = await jarvsInstance.processarPergunta(userText);
                console.log('‚úÖ Resposta recebida');
                addBotMessage(botResponseHtml);
            } catch (error) {
                console.error("‚ùå Erro ao processar pergunta:", error);
                addBotMessage(`
                    <p>Desculpe, ${jarvsInstance.nomeUsuario}, ocorreu um erro inesperado.</p>
                    <p>Tente reformular sua pergunta ou verifique sua conex√£o.</p>
                `);
            } finally {
                hideTyping();
            }
        };

        // ================================================================
        // EVENT LISTENERS - LIMPOS E FUNCIONAIS
        // ================================================================

        // Limpar event listeners anteriores do FAB
        const newFab = fabButton.cloneNode(true);
        fabButton.parentNode.replaceChild(newFab, fabButton);
        
        // Event listener principal do FAB
        newFab.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('üéØ FAB clicado - abrindo Jarvs');
            openModal();
        });

        // Event listeners dos outros elementos
        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', closeModal);
        }

        if (sendBtn) {
            sendBtn.addEventListener('click', handleSendMessage);
        }

        if (inputField) {
            inputField.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });

            inputField.placeholder = "Converse com Jarvs";
        }

        // Fechar modal clicando fora
        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal();
            }
        });

        console.log('‚úÖ Jarvs Completo configurado com sucesso!');
        
    }, 1000); // Aguardar 1 segundo para garantir que tudo carregou
});

// ================================================================
// FUN√á√ïES GLOBAIS PARA TESTE
// ================================================================

window.testarJarvs = function() {
    console.log('üß™ Testando Jarvs...');
    const modal = document.getElementById('ai-assistant-modal');
    if (modal) {
        modal.style.display = 'block';
        modal.style.visibility = 'visible';
        modal.style.opacity = '1';
        console.log('‚úÖ Modal aberto via teste');
        return true;
    } else {
        console.log('‚ùå Modal n√£o encontrado');
        return false;
    }
};

window.testarIA = async function(pergunta = "Como est√° minha sa√∫de financeira?") {
    if (jarvsInstance) {
        console.log('ü§ñ Testando IA com pergunta:', pergunta);
        try {
            const resposta = await jarvsInstance.processarPergunta(pergunta);
            console.log('‚úÖ Resposta da IA:', resposta);
            return resposta;
        } catch (error) {
            console.error('‚ùå Erro ao testar IA:', error);
            return null;
        }
    } else {
        console.log('‚ùå Inst√¢ncia Jarvs n√£o encontrada');
        return null;
    }
};

// ================================================================
// EXPORTAR PARA USO GLOBAL
// ================================================================

window.JarvsAnaliseFinanceira = AnaliseFinanceiraAvancada;
window.jarvsInstance = jarvsInstance;

console.log('üì¶ Jarvs Completo carregado com todas as funcionalidades!');